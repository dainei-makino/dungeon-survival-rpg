# 音楽生成システム再構成計画

このドキュメントでは、ゲーム内で利用する音楽生成システムを段階的に再構成する手順を説明します。目標は、基本的なシンセサイザー機能から楽曲自動生成までを網羅する4層構造の仕組みを整えることです。

## 1. シンセサイザー基盤クラス

まず、WebAudio API を利用した低レベルのシンセサイザー機能を実装します。

- **Oscillator**、**Gain** などのノードを生成し、波形・音量・エンベロープを制御できるクラス `BasicSynth` を作成する。
- 音源の開始・停止、音程・音量の調整、簡易なエフェクト(フィルター、ディレイ)を扱えることを目指す。
- 今後拡張しやすいように、各種ノードのパラメータはオブジェクトで受け取る設計にする。

## 2. 音色クラスとデータ

`BasicSynth` を基に、具体的な楽器の特性を表現したクラス群を用意します。

- ピアノ、パッド、ウッドベースなど、代表的な音色ごとに `Instrument` クラスを継承した実装を作成する。
- それぞれのクラスでは、利用する波形タイプやエンベロープ値などの初期設定をカプセル化する。
- 音色データ(JSON 形式を想定)として、複数のプリセットを読み込める仕組みを用意する。

## 3. 自動作曲クラス

複数の `Instrument` を利用して実際の楽曲データを生成するクラスを実装します。

- シーケンスパターンやコード進行を入力として受け取り、各トラックのノートイベントを生成する `MusicGenerator` を定義する。
- ミキサーとして複数トラックの音量バランスを管理し、ループ再生やフェードアウトの制御も担当させる。
- 将来的にはランダム生成アルゴリズムを組み込み、特定のスタイルに沿った伴奏やメロディを自動生成できるようにする。

## 4. バイオーム設定

ゲーム内のバイオーム(地形・環境)ごとに適した音楽を自動生成するため、音色やテンポなどをまとめた設定ファイルを作成します。

- バイオームごとに次の項目を定義する:
  - 使用する `Instrument` の種類と数
  - 楽曲の雰囲気(明るさ・暗さなど)と曲調(メジャー/マイナーなど)
  - 基本テンポ、キー、スケール
  - リズムパターンや和声進行
  - 長期展開、中期展開の構成
- `MusicGenerator` はこの設定を読み込み、該当バイオームのステージに入ったとき自動で曲を生成・再生する。

## 実装の進め方

1. **`BasicSynth` の設計とユニットテスト**
   - WebAudio API で必要なノードを管理するクラス構造を実装し、単音の再生が行えることを確認する。
2. **音色クラスの追加**
   - プリセットデータ形式を決め、簡単なピアノ・パッド音色を実装。`MusicGenerator` から呼び出して音を鳴らすところまで動作確認する。
3. **自動作曲機能の初期実装**
   - コード進行とリズムパターンを固定した状態で、複数トラックの生成が行えるようにする。
4. **バイオーム設定の導入**
   - 現在のゲームのバイオーム管理コードと連携し、バイオーム変更時に `MusicGenerator` が参照する設定を切り替える処理を追加する。
5. **機能拡張**
   - ランダム生成アルゴリズムや追加のエフェクト、複数バイオームのプリセットを充実させていく。

以上の手順で段階的に実装を進めることで、大規模な変更を抑えつつ安定した音楽生成システムへ移行できます。
